<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2ow-ch</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f7f7f7; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
        .thread-list { margin-top: 20px; }
        .thread-item { padding: 10px; border-bottom: 1px solid #ddd; cursor: pointer; position: relative; }
        .thread-item:hover { background-color: #f0f0f0; }
        .thread-item .delete-button { position: absolute; right: 10px; top: 10px; display: none; }
        .thread-item.admin .delete-button { display: block; }
        .post { border-bottom: 1px solid #ddd; padding: 10px 0; }
        .post:last-child { border-bottom: none; }
        .post-number { font-weight: bold; color: #555; }
        .name { font-weight: bold; color: green; cursor: pointer; }
        .message { margin: 5px 0; }
        .timestamp { font-size: 0.9em; color: #888; margin-top: 5px; }
        .email { font-size: 0.9em; color: blue; margin-top: 5px; display: none; }
        .post.admin .email { display: block; }
        .admin-controls { margin-top: 10px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>2ow-ch</h2>
    <p>ようこそ！2ow-chへ！</p>

    <!-- 管理者認証 -->
    <button id="adminButton" onclick="showPasswordInput()">管理者ですか？</button>
    <div id="passwordContainer" class="hidden">
        <input type="password" id="adminPassword" placeholder="パスワードを入力">
        <button onclick="authenticateAdmin()">認証</button>
    </div>

    <!-- スレッド作成ビュー -->
    <div id="threadCreateView">
        <h3>スレッド作成</h3>
        <form id="threadForm">
            <input type="text" id="threadTitle" placeholder="スレッドタイトルを入力" style="width: 100%;"><br><br>
            <button type="button" onclick="createThread()">作成</button>
        </form>

        <div class="thread-list">
            <h3>スレッド一覧</h3>
            <div id="threadList"></div>
        </div>
    </div>

    <!-- スレッド表示ビュー -->
    <div id="threadView" class="hidden">
        <h3 id="currentThreadTitle"></h3>
        <button onclick="backToThreadCreate()">← 戻る</button>
        <div id="posts"></div>
        <form id="postForm">
            <input type="text" id="name" placeholder="名前 (任意)" style="width: 100%;"><br><br>
            <input type="email" id="email" placeholder="メールアドレス" style="width: 100%;" required><br><br>
            <textarea id="message" rows="4" cols="50" placeholder="ここにメッセージを入力してください"></textarea><br><br>
            <button type="button" onclick="postMessage()">投稿</button>
        </form>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCILXdTDzxzwyZvv1XB8ZilAWGw4MWhDmk",
        authDomain: "ow-ch-888e8.firebaseapp.com",
        projectId: "ow-ch-888e8",
        storageBucket: "ow-ch-888e8.appspot.com",
        messagingSenderId: "153239068124",
        appId: "1:153239068124:web:af1430e7a56b821bb48319"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentThreadId = null;
    let isAdmin = false;

    document.addEventListener("DOMContentLoaded", () => {
        loadThreads();
    });

    function showPasswordInput() {
        document.getElementById("passwordContainer").classList.remove("hidden");
    }

    function authenticateAdmin() {
        const password = document.getElementById("adminPassword").value;
        if (password === "onull9999") { // OP用パスワード
            isAdmin = true;
            alert("管理者モードを有効化しました。");
            document.getElementById("passwordContainer").classList.add("hidden");
            loadThreads(); // スレッドリストを再読み込み
        } else {
            alert("パスワードが間違っています。");
        }
    }

    function createThread() {
        const title = document.getElementById("threadTitle").value.trim();
        if (!title) {
            alert("タイトルを入力してください。");
            return;
        }

        const thread = { title, createdAt: firebase.firestore.FieldValue.serverTimestamp(), lastPostNumber: 0 };
        db.collection("threads").add(thread).then(() => {
            document.getElementById("threadTitle").value = '';
            loadThreads();
        });
    }

    function loadThreads() {
        db.collection("threads").orderBy("createdAt", "desc").get().then(querySnapshot => {
            const threadList = document.getElementById("threadList");
            threadList.innerHTML = '';
            querySnapshot.forEach(doc => {
                const thread = doc.data();
                const threadItem = document.createElement("div");
                threadItem.classList.add("thread-item");
                threadItem.textContent = thread.title;

                if (isAdmin) {
                    threadItem.classList.add("admin");
                    const deleteButton = document.createElement("button");
                    deleteButton.textContent = "削除";
                    deleteButton.classList.add("delete-button");
                    deleteButton.onclick = (event) => {
                        event.stopPropagation();
                        deleteThread(doc.id);
                    };
                    threadItem.appendChild(deleteButton);
                }

                threadItem.onclick = () => showThreadView(doc.id, thread.title);
                threadList.appendChild(threadItem);
            });
        });
    }

    function deleteThread(threadId) {
        if (confirm("このスレッドを削除しますか？")) {
            db.collection("threads").doc(threadId).delete().then(() => {
                loadThreads();
            });
        }
    }

    function showThreadView(threadId, threadTitle) {
        currentThreadId = threadId;
        document.getElementById("threadCreateView").classList.add("hidden");
        document.getElementById("threadView").classList.remove("hidden");
        document.getElementById("currentThreadTitle").textContent = threadTitle;

        loadPosts();
    }

    function backToThreadCreate() {
        document.getElementById("threadCreateView").classList.remove("hidden");
        document.getElementById("threadView").classList.add("hidden");
        currentThreadId = null;
    }

    function loadPosts() {
        const postsContainer = document.getElementById("posts");
        postsContainer.innerHTML = '';
        db.collection("threads").doc(currentThreadId).collection("posts").orderBy("timestamp").get().then(querySnapshot => {
            let postNumber = 0;
            querySnapshot.forEach(postDoc => {
                const post = postDoc.data();
                postNumber++;
                const postElement = document.createElement("div");
                postElement.classList.add("post");
                if (isAdmin) postElement.classList.add("admin");

                postElement.innerHTML = `
                    <div class="post-number">#${postNumber}</div>
                    <div>
                        <div class="name">${post.name || "名無し"}</div>
                        <div class="message">${parseMentions(post.message)}</div>
                        <div class="timestamp">${new Date(post.timestamp.toDate()).toLocaleString()}</div>
                        <div class="email">メール: ${post.email}</div>
                    </div>
                `;

                if (isAdmin) {
                    const deleteButton = document.createElement("button");
                    deleteButton.textContent = "削除";
                    deleteButton.onclick = () => deletePost(postDoc.id);
                    postElement.appendChild(deleteButton);
                }

                postsContainer.appendChild(postElement);
            });
        });
    }

    function parseMentions(message) {
        return message.replace(/>>\d+/g, '<a href="#">$&</a>');
    }

    function postMessage() {
        const name = document.getElementById("name").value.trim();
        const email = document.getElementById("email").value.trim();
        const message = document.getElementById("message").value.trim();
        if (!email) {
            alert("メールアドレスを入力してください。");
            return;
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            alert("有効なメールアドレスを入力してください。");
            return;
        }

        if (!message) {
            alert("メッセージを入力してください。");
            return;
        }

        db.collection("threads").doc(currentThreadId).get().then(doc => {
            const threadData = doc.data();
            const newPostNumber = (threadData.lastPostNumber || 0) + 1;

            const post = {
                name: name || "名無し",
                email,
                message,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                postNumber: newPostNumber,
            };

            db.collection("threads").doc(currentThreadId).collection("posts").add(post).then(() => {
                db.collection("threads").doc(currentThreadId).update({ lastPostNumber: newPostNumber });
                loadPosts();
                document.getElementById("message").value = '';
            });
        });
    }

    function deletePost(postId) {
        if (confirm("この投稿を削除しますか？")) {
            db.collection("threads").doc(currentThreadId).collection("posts").doc(postId).delete().then(() => {
                loadPosts();
            });
        }
    }
</script>

</body>
</html>
